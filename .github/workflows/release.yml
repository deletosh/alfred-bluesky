name: Build and Release

on:
  push:
    branches:
      - main
      - master

jobs:
  tag-and-release:
    runs-on: macos-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install
          fi

      # Get version from package.json and create tag if it doesn't exist
      - name: Check and create tag
        id: check_tag
        run: |
          PKG_VERSION=$(node -p "require('./package.json').version")
          TAG="v$PKG_VERSION"
          
          # Check if tag exists
          if ! git rev-parse "$TAG" >/dev/null 2>&1; then
            echo "Creating new tag: $TAG"
            git tag "$TAG"
            git push origin "$TAG"
            echo "NEW_TAG=true" >> $GITHUB_OUTPUT
            echo "VERSION=$PKG_VERSION" >> $GITHUB_OUTPUT
          else
            echo "Tag $TAG already exists, skipping release"
            echo "NEW_TAG=false" >> $GITHUB_OUTPUT
          fi

      # Only continue if we created a new tag
      - name: Create Alfred workflow
        if: steps.check_tag.outputs.NEW_TAG == 'true'
        run: |
          zip -r "alfred-bluesky.alfredworkflow" . \
          -x "*.git*" \
          -x ".github/*" \
          -x "*.DS_Store" \
          -x "node_modules/*" \
          -x "demo/*" \
          -x "*.md" \
          -x "package-lock.json" \
          -x "package.json" \
          -x ".gitignore"

      # Create the release
      - name: Create Release
        if: steps.check_tag.outputs.NEW_TAG == 'true'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.check_tag.outputs.VERSION }}
          files: alfred-bluesky.alfredworkflow
          name: Release ${{ steps.check_tag.outputs.VERSION }}
          draft: false
          prerelease: false
          body: |
            Release notes for version ${{ steps.check_tag.outputs.VERSION }}
            
            ## Installation
            1. Download the `alfred-bluesky.alfredworkflow` file
            2. Double-click to install in Alfred
            3. Follow the setup instructions in the README
            
            ## Changes in this version:
            - Please edit release notes here

        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}